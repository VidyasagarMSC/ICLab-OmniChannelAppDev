<!DOCTYPE html>
<html lang="en">
<head>
  <link rel='stylesheet' href='stylesheets/protected.css'/>
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <div id="maindiv" class="main-container">
    <div class="top-container">
      <div class="flex-top">
        <img id="userProfileImg" class="user-profile" src="images/placeholder-hi.png">
      </div>
      <div class="flex-top">
        <h1>Hi <span id="userNameSpan"></span>,</h1>
        <h1>Welcome to BMDService .</h1>
        <div class="flex-top">
          <button class="button" onclick="registerPush();">Enable Push</button>
        </div>
      </div>
    </div>
    <div class="bottom-container">
      <div class="flex-bottom">
        <h2>You are using IBM credentials. <br/>We encourage you to go edit Facebook/Google settings in the console.</h2>
      </div>
      <div id="container1">
        <div class="one"> <img class='resize_fit_center1' src="images/IBMBlueMix.png">
        </div>
      </div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.1.1.js"></script>
  <script>
  // Sending a request to the server in order to populate the data we need to display
  $.ajax({
    url: 'protected/getAuthData', success: function (result) {
      $('#userNameSpan').html(result.userName);
      $('#userProfileImg').attr('src', result.profilePicture);
      $("#maindiv").attr('style', 'visibility: visible');

      // Save the tokens payload on the session in order to display the data on token.html
      window.sessionStorage.setItem('idTokenInfo', JSON.stringify(result.idTokenInfo));
      window.sessionStorage.setItem('accessTokenInfo', JSON.stringify(result.accessTokenInfo));
      window.sessionStorage.setItem('appId', JSON.stringify(result.appId));
      window.sessionStorage.setItem('clientSecret', JSON.stringify(result.clientSecret));
      window.sessionStorage.setItem('userId', JSON.stringify(result.userName));
      window.sessionStorage.setItem('appRegion', JSON.stringify(result.appRegion));
    }
  });
  </script>
  <script src="BMSPushSDK.js"></script>
  <script>
  function registerPush(){

    var bmsPush = new BMSPush()
    function callback(response) {
      alert(response.response)
    }
    var initParams = {
      "appGUID":JSON.parse(window.sessionStorage.getItem('appId')),
      "appRegion":JSON.parse(window.sessionStorage.getItem('appRegion')),
      "clientSecret":JSON.parse(window.sessionStorage.getItem('clientSecret'))
    }

    var userId = JSON.parse(window.sessionStorage.getItem('userId'));
    bmsPush.initialize(initParams, callback)
    bmsPush.registerWithUserId(userId,function(response) {
      alert(response.response)
    })

  }
  </script>>
</body>
</html>
